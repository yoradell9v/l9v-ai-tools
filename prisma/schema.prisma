generator client {
  provider   = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deactivatedAt DateTime?
  
  users     UserOrganization[]
  invitations InvitationToken[]

  knowledgeBase OrganizationKnowledgeBase?

   // Tool outputs (read from knowledge base, write insights back)
  jobDescriptions SavedAnalysis[]
  sops           SOP[]
  conversations  BusinessConversation[]
  enhancementAnalyses EnhancementAnalysis[]
}

model User {
  id        String   @id @default(cuid())
  firstname String
  lastname  String
  email     String   @unique
  password  String   
  
  globalRole GlobalRole? 
  timezone  String?  @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  
  organizations UserOrganization[]
  refreshTokens RefreshToken[]
  
  @@index([email])
  @@index([globalRole])
}

enum GlobalRole {
  SUPERADMIN
  ADMIN
  MEMBER
}

model UserOrganization {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  role           TenantRole
  createdAt      DateTime @default(now())
  deactivatedAt  DateTime?
  
  savedAnalyses SavedAnalysis[]
  refinementMessages RefinementMessage[]
  sops          SOP[]
  businessConversations BusinessConversation[]
  
  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([deactivatedAt])
}

enum TenantRole {
  ADMIN
  MEMBER
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model InvitationToken {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  email          String
  role           TenantRole
  token          String   @unique
  expiresAt      DateTime
  
  acceptedAt     DateTime?
  acceptedBy     String?
  cancelledAt    DateTime?
  
  createdAt      DateTime @default(now())
  createdBy      String
  
  @@unique([organizationId, email])
  @@index([token])
  @@index([organizationId])
}

model OrganizationKnowledgeBase{
  id String @id @default(cuid())
  organizationId String @unique
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  //Core Identity Tier 1 Required
  businessName String?
  website String?
  industry String?
  industryOther String?
  whatYouSell String? @db.Text

  //Business Context Tier 1
  monthlyRevenue String?
  teamSize String?
  primaryGoal String?
  biggestBottleNeck String?

  //Customer and Market Tier 2
  idealCustomer String? @db.Text
  topObjection String?
  coreOffer String? @db.Text
  customerJourney String @db.Text

  //Operations and Tools Tier 2
  toolStack String[]
  primaryCRM String?
  defaultTimeZone String?
  bookingLink String?
  supportEmail String?

  //Brand & Voice (Tier 2)
  brandVoiceStyle String?
  riskBoldness String?
  voiceExampleGood String? @db.Text
  voiceExamplesAvoid String? @db.Text
  contentLinks String? @db.Text

  //Compliance Tier 2
  isRegulated Boolean? @default(false)
  regulatedIndustry String?
  forbiddenWords String? @db.Text
  disclaimers String? @db.Text

  //HR Defaults
  defaultWeeklyHours String?
  defaultManagementStyle String?
  defaultEnglishLevel String?

  //Proof & Credibility
  proofAssets String? @db.Text
  proofFiles Json?

  //Additional Context
  pipeLineStages String?
  emailSignOff String?

  //AI-Generated Insights
  aiInsights     Json? // {
    // "customerPatterns": [...],
    // "successfulMessaging": [...],
    // "industryBenchmarks": {...},
    // "recommendedTools": [...],
    // "optimizationSuggestions": [...]
  // }

  //KnowledgeExtraction (data extracted from tool usage)
  extractedKnowledge Json? // {
    // "commonTasks": [...], // From JD builder
    // "standardProcesses": [...], // From SOP generator
    // "frequentQuestions": [...], // From chat
    // "successPatterns": {...}
  // }

  //Completion and Quality (deterministic)
  completeness Int? // 0-100 overall score
  completenessBreakdown Json? // Tier breakdowns, tool readiness

  //AI Quality Analysis (will add later)
  aiQualityScore Int?
  aiQualityAnalysis Json?
  aiQualityAnalyzedAt DateTime?

  //Versioning
  version Int @default(1)
  lastEditedBy String //userId
  lastEditedAt DateTime?
  contributors String[]

  //Enrichment tracking
  lastEnrichedAt DateTime?
  enrichmentVersion Int 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contributingSources KnowledgeSource[]
  learningEvents LearningEvent[]
  conversations BusinessConversation[]
  enhancementAnalyses EnhancementAnalysis[]
}

model KnowledgeSource {
  id String @id @default(cuid())
  knowledgeBaseId String
  knowledgeBase OrganizationKnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  sourceType KnowledgeSourceType
  sourceId String //Id of the jd, sop, or conversation

  //What was learned
  contributeFields String[]
  extractedData Json?
  confidence Int

  //Metadata
  contributedBy String
  contributedAt DateTime @default(now())

  @@index([knowledgeBaseId])
  @@index([sourceType])
  @@index([contributedAt])
}

enum KnowledgeSourceType {
  INITIAL_ONBOARDING
  JOB_DESCRIPTION
  SOP_GENERATION
  CHAT_CONVERSATION
  MANUAL_UPDATE
  FILE_UPLOAD
  AI_ENRICHMENT
}

model LearningEvent {
  id String @id @default(cuid())
  knowledgeBaseId String
  knowledgeBase OrganizationKnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  eventType LearningEventType

  insight String @db.Text
  category String
  confidence Int

  triggeredBy String?
  sourceIds String[]
  metadata Json? // Structured metadata from ExtractedInsight for mapping to KB fields

  applied Boolean @default(false)
  appliedAt DateTime?
  appliedToFields String[]

  createdAt DateTime @default(now())

  @@index([knowledgeBaseId])
  @@index([eventType])
  @@index([category])
  @@index([createdAt])
}

enum LearningEventType{
  PATTERN_DETECTED
  OPTIMIZATION_FOUND
  INSIGHT_GENERATED
  INCONSISTENCY_FIXED
  KNOWLEDGE_EXPANDED
}


model SavedAnalysis {
  id                    String   @id @default(cuid())
  userOrganizationId    String
  userOrganization      UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization Organization @relation(fields:[organizationId], references:[id], onDelete: Cascade)

  title                 String
  intakeData            Json
  analysis              Json

  //Knowledge Base Integration
  usedKnowledgeBaseVersion Int?
  knowledgeBaseSnapshot Json?
  contributedInsights Json?

  parentAnalysisId      String?
  parentAnalysis        SavedAnalysis? @relation("AnalysisRefinements", fields: [parentAnalysisId], references: [id], onDelete: Cascade)
  refinedVersions       SavedAnalysis[] @relation("AnalysisRefinements")
  
  isFinalized           Boolean @default(false)
  finalizedAt           DateTime?
  versionNumber         Int @default(1)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  refinements           RefinementMessage[]
  
  @@index([userOrganizationId])
  @@index([createdAt])
  @@index([isFinalized])
  @@index([parentAnalysisId])
}

model RefinementMessage {
  id                    String   @id @default(cuid())
  analysisId            String
  analysis              SavedAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  userOrganizationId    String
  userOrganization      UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  role                  MessageRole
  content               String @db.Text
  
  changedSections       String[]
  analysisSnapshot      Json?
  
  sequenceNumber        Int
  createdAt             DateTime @default(now())
  
  @@unique([analysisId, sequenceNumber])
  @@index([analysisId])
  @@index([userOrganizationId])
  @@index([sequenceNumber])
}

enum MessageRole {
  user
  assistant
}

model SOP {
  id                 String   @id @default(cuid())
  userOrganizationId String
  userOrganization   UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization Organization @relation(fields:[organizationId], references:[id], onDelete: Cascade)

  title              String
  content            Json       
  intakeData         Json

  //Knowledge Base Integration
  usedKnowledgeBaseVersion Int?
  knowledgeBaseSnapshot Json?
  contributedInsights Json?

  metadata           Json?
  
  // VERSIONING FIELDS
  versionNumber      Int      @default(1)  // Integer version: 1, 2, 3, etc.
  rootSOPId          String?  // Points to the original SOP (first version)
  rootSOP            SOP?     @relation("SOPVersions", fields: [rootSOPId], references: [id], onDelete: Cascade)
  versions           SOP[]    @relation("SOPVersions")  // All versions of this SOP
  isCurrentVersion   Boolean  @default(true)  // Only latest version is true
  
  // Version metadata
  versionCreatedBy   String?  // userId who created this version
  versionCreatedAt   DateTime? // When this version was created
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  @@index([userOrganizationId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([rootSOPId])  // For finding all versions
  @@index([isCurrentVersion])  // For filtering current versions
  @@index([rootSOPId, versionNumber])  // Composite for version queries
  @@index([rootSOPId, isCurrentVersion])  // Composite for finding current version
}

model EnhancementAnalysis {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  knowledgeBaseId String
  knowledgeBase   OrganizationKnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  
  // The analysis result
  analysis        Json     // Analysis of knowledge base completeness/quality
  
  // Cache invalidation
  dataHash        String   // Hash of knowledge base fields to detect changes
  analyzedFields  String[] // Which fields were analyzed
  fieldConfidences Json?   // Confidence scores per field: { "businessName": 95, "idealCustomer": 60, ... }
  
  // Metadata
  generatedAt     DateTime @default(now())
  generatedBy     String?  // userOrganizationId who triggered it
  
  // Version tracking
  version         Int      @default(1)
  
  @@index([organizationId])
  @@index([knowledgeBaseId])
  @@index([generatedAt])
  @@index([dataHash])
}

model BusinessConversation {
  id                 String   @id @default(cuid())
  organizationId     String
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  knowledgeBaseId     String
  knowledgeBase      OrganizationKnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  
  userOrganizationId String
  userOrganization   UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  title              String   @default("New Conversation") 
  
  // KNOWLEDGE BASE INTEGRATION
  usedKnowledgeBaseVersion Int?
  contributedInsights      Json? // Questions asked, topics discussed, pain points mentioned

  status             ConversationStatus @default(ACTIVE)
  lastMessageAt      DateTime @default(now())
  messageCount       Int      @default(0)
  
  activeTopics       String[] // Topics/sections from knowledge base being discussed
  contextSummary     String? @db.Text  // AI-generated summary of conversation so far
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  messages           BusinessMessage[]
  
  @@index([organizationId])
  @@index([knowledgeBaseId])
  @@index([userOrganizationId])
  @@index([status])
  @@index([lastMessageAt])
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

model BusinessMessage {
  id                 String   @id @default(cuid())
  conversationId     String
  conversation       BusinessConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role               MessageRole      // user | assistant
  content            String   @db.Text
  
  // Rich metadata for AI responses
  metadata           Json?    // {
                              //   confidenceScore: 85,
                              //   citedSources: [...],
                              //   tokenCount: 450,
                              //   model: "gpt-4o",
                              //   promptTokens: 2000,
                              //   completionTokens: 450
                              // }
  
  // For user messages
  attachments        Json?    // Array of file references if user uploads files
  
  // For assistant messages
  knowledgeBaseCitations Json? // Structured citations: { field: "businessName", excerpt: "...", confidence: 95 }
  generatedArtifacts Json?    // If AI generates content based on knowledge base
  
  sequenceNumber     Int
  createdAt          DateTime @default(now())
  
  @@unique([conversationId, sequenceNumber])
  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
}
