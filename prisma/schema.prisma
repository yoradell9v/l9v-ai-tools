generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  invitations InvitationToken[]
  users       UserOrganization[]
}

model User {
  id               String             @id @default(cuid())
  firstname        String
  lastname         String
  email            String             @unique
  password         String
  globalRole       GlobalRole?
  timezone         String?            @default("America/New_York")
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  lastLoginAt      DateTime?
  resetToken       String?            @unique
  resetTokenExpiry DateTime?
  refreshTokens    RefreshToken[]
  organizations    UserOrganization[]

  @@index([email])
  @@index([globalRole])
}

model UserOrganization {
  id                 String              @id @default(cuid())
  userId             String
  organizationId     String
  role               TenantRole
  createdAt          DateTime            @default(now())
  businessBrains     BusinessBrain[]
  refinementMessages RefinementMessage[]
  sops               SOP[]
  savedAnalyses      SavedAnalysis[]
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model InvitationToken {
  id             String       @id @default(cuid())
  organizationId String
  email          String
  role           TenantRole
  token          String       @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  acceptedBy     String?
  createdAt      DateTime     @default(now())
  createdBy      String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([token])
  @@index([organizationId])
}

model SavedAnalysis {
  id                 String              @id @default(cuid())
  userOrganizationId String
  title              String
  intakeData         Json
  analysis           Json
  isFinalized        Boolean             @default(false)
  finalizedAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  refinements        RefinementMessage[]
  userOrganization   UserOrganization    @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)

  @@index([userOrganizationId])
  @@index([createdAt])
  @@index([isFinalized])
}

model RefinementMessage {
  id                 String           @id @default(cuid())
  analysisId         String
  userOrganizationId String
  role               MessageRole
  content            String
  changedSections    String[]
  analysisSnapshot   Json?
  sequenceNumber     Int
  createdAt          DateTime         @default(now())
  analysis           SavedAnalysis    @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  userOrganization   UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)

  @@unique([analysisId, sequenceNumber])
  @@index([analysisId])
  @@index([userOrganizationId])
  @@index([sequenceNumber])
}

model SOP {
  id                 String           @id @default(cuid())
  userOrganizationId String
  title              String
  content            Json
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  userOrganization   UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)

  @@index([userOrganizationId])
}

model BusinessBrain {
  id                 String           @id @default(cuid())
  userOrganizationId String
  trainingData       Json
  knowledgeBase      Json
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  userOrganization   UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)

  @@index([userOrganizationId])
}

enum GlobalRole {
  SUPERADMIN
}

enum TenantRole {
  ADMIN
  USER
}

enum MessageRole {
  user
  assistant
}