generator client {
  provider   = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deactivatedAt DateTime?
  
  users     UserOrganization[]
  invitations InvitationToken[]
}

model User {
  id        String   @id @default(cuid())
  firstname String
  lastname  String
  email     String   @unique
  password  String   
  
  globalRole GlobalRole? 
  timezone  String?  @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  
  organizations UserOrganization[]
  refreshTokens RefreshToken[]
  
  @@index([email])
  @@index([globalRole])
}

enum GlobalRole {
  SUPERADMIN
  ADMIN
  MEMBER
}

model UserOrganization {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  role           TenantRole
  createdAt      DateTime @default(now())
  deactivatedAt  DateTime?
  
  savedAnalyses SavedAnalysis[]
  refinementMessages RefinementMessage[]
  sops          SOP[]
  businessBrains BusinessBrain[]
  businessConversations BusinessConversation[]
  
  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([deactivatedAt])
}

enum TenantRole {
  ADMIN
  MEMBER
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model InvitationToken {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  email          String
  role           TenantRole
  token          String   @unique
  expiresAt      DateTime
  
  acceptedAt     DateTime?
  acceptedBy     String?
  cancelledAt    DateTime?
  
  createdAt      DateTime @default(now())
  createdBy      String
  
  @@unique([organizationId, email])
  @@index([token])
  @@index([organizationId])
}

model SavedAnalysis {
  id                    String   @id @default(cuid())
  userOrganizationId    String
  userOrganization      UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  title                 String
  intakeData            Json
  analysis              Json

  
  parentAnalysisId      String?
  parentAnalysis        SavedAnalysis? @relation("AnalysisRefinements", fields: [parentAnalysisId], references: [id], onDelete: Cascade)
  refinedVersions       SavedAnalysis[] @relation("AnalysisRefinements")
  
  isFinalized           Boolean @default(false)
  finalizedAt           DateTime?
  versionNumber         Int @default(1)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  refinements           RefinementMessage[]
  
  @@index([userOrganizationId])
  @@index([createdAt])
  @@index([isFinalized])
  @@index([parentAnalysisId])
}

model RefinementMessage {
  id                    String   @id @default(cuid())
  analysisId            String
  analysis              SavedAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  userOrganizationId    String
  userOrganization      UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  role                  MessageRole
  content               String @db.Text
  
  changedSections       String[]
  analysisSnapshot      Json?
  
  sequenceNumber        Int
  createdAt             DateTime @default(now())
  
  @@unique([analysisId, sequenceNumber])
  @@index([analysisId])
  @@index([userOrganizationId])
  @@index([sequenceNumber])
}

enum MessageRole {
  user
  assistant
}

model SOP {
  id                 String   @id @default(cuid())
  userOrganizationId String
  userOrganization   UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  title              String
  content            Json
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  @@index([userOrganizationId])
}

model BusinessCard {
  id             String   @id @default(cuid())
  brainId        String
  brain          BusinessBrain @relation(fields: [brainId], references: [id], onDelete: Cascade)

  type           String            // e.g. "marketing", "operations", "financial", "strategy"
  title          String
  description    String @db.Text   // long explanation
  priority       Int?              // optional (1â€“5)
  metadata       Json?             // flexible for future AI fields
  orderIndex     Int               // for UI ordering
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([brainId])
  @@index([type])
}


model BusinessBrain {
  id                 String   @id @default(cuid())
  userOrganizationId String
  userOrganization   UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  // intake form
  intakeData         Json              // raw submitted form values
  fileUploads        Json?             // file URLs (images, pdfs, documents)

  // AI-related
  knowledgeBase      Json?

  cards              BusinessCard[]
  conversations     BusinessConversation[]
  enhancementAnalyses EnhancementAnalysis[]
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  
  completionScore    Int?
  completionData     Json?
  
  // Completion data structure:
  // {
  //   tierOneComplete: boolean,
  //   tierTwoSections: {
  //     compliance: boolean,
  //     proof: boolean,
  //     voice: boolean,
  //     operations: boolean
  //   },
  //   quickWins: [
  //     {
  //       id: string,
  //       label: string,
  //       completed: boolean,
  //       impact: number, // +10%, +15%, etc.
  //       category: string
  //     }
  //   ],
  //   lastCalculated: timestamp
  // }
  
  
  @@index([userOrganizationId])
}

model EnhancementAnalysis {
  id              String   @id @default(cuid())
  brainId         String
  brain           BusinessBrain @relation(fields: [brainId], references: [id], onDelete: Cascade)
  
  // The analysis result
  analysis        Json     // The full enhancementAnalysis object
  
  // Cache invalidation
  dataHash        String   // Hash of cards + intakeData + fileUploads to detect changes
  cardIds         String[] // Which cards were analyzed
  cardConfidences Int[]    // Confidence scores at time of analysis
  
  // Metadata
  generatedAt     DateTime @default(now())
  generatedBy     String?  // userOrganizationId who triggered it
  
  // Version tracking
  version         Int      @default(1)
  
  @@index([brainId])
  @@index([generatedAt])
  @@index([dataHash])
}

model BusinessConversation {
  id                 String   @id @default(cuid())
  brainId            String
  brain              BusinessBrain @relation(fields: [brainId], references: [id], onDelete: Cascade)
  
  userOrganizationId String
  userOrganization   UserOrganization @relation(fields: [userOrganizationId], references: [id], onDelete: Cascade)
  
  title              String   @default("New Conversation")  // Auto-generated from first message
  
  // Conversation state
  status             ConversationStatus @default(ACTIVE)
  lastMessageAt      DateTime @default(now())
  messageCount       Int      @default(0)
  
  // Context tracking
  activeCardIds      String[]          // Which cards are currently relevant
  contextSummary     String? @db.Text  // AI-generated summary of conversation so far
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  messages           BusinessMessage[]
  
  @@index([brainId])
  @@index([userOrganizationId])
  @@index([status])
  @@index([lastMessageAt])
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

model BusinessMessage {
  id                 String   @id @default(cuid())
  conversationId     String
  conversation       BusinessConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role               MessageRole      // user | assistant
  content            String   @db.Text
  
  // Rich metadata for AI responses
  metadata           Json?    // {
                              //   cardsReferenced: ["card_id_1", "card_id_2"],
                              //   confidenceScore: 85,
                              //   citedSources: [...],
                              //   tokenCount: 450,
                              //   model: "gpt-4o",
                              //   promptTokens: 2000,
                              //   completionTokens: 450
                              // }
  
  // For user messages
  attachments        Json?    // Array of file references if user uploads files
  
  // For assistant messages
  cardCitations      Json?    // Structured citations: { cardId, excerpts, confidence }
  generatedArtifacts Json?    // If AI generates content based on cards
  
  sequenceNumber     Int
  createdAt          DateTime @default(now())
  
  @@unique([conversationId, sequenceNumber])
  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
}